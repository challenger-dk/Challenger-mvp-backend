name: Deploy to Raspberry Pi (native build)

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/workflows/deploy-production.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Don't deploy to Raspberry Pi if this is a merge back from production
    if: "!contains(github.event.head_commit.message, 'Merge branch ''production''')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.4'
          cache: true
          cache-dependency-path: go.sum

      - name: Lint - Check sanitize validation tags
        run: go run tools/validate-sanitize/main.go

      - name: Connect GitHub Actions runner to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_CLIENT_SECRET }}
          tags: tag:ci

      - name: Prepare deployment directory on Raspberry Pi
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USER }}
          key: ${{ secrets.PI_SSH_KEY }}
          port: ${{ secrets.PI_SSH_PORT || 22 }}
          script: |
            # Create target directory if it doesn't exist
            mkdir -p /home/${{ secrets.PI_USER }}/challenger-app
            
            # Ensure the directory is owned by the deployment user
            sudo chown -R ${{ secrets.PI_USER }}:${{ secrets.PI_USER }} /home/${{ secrets.PI_USER }}/challenger-app
            
            # Set proper permissions (755 for directories, 644 for files)
            sudo chmod -R 755 /home/${{ secrets.PI_USER }}/challenger-app
            
            # Remove Database/migrations if it exists with wrong permissions
            if [ -d /home/${{ secrets.PI_USER }}/challenger-app/Database/migrations ]; then
              sudo rm -rf /home/${{ secrets.PI_USER }}/challenger-app/Database/migrations
            fi
            
            # Create Database/migrations directory with proper permissions
            mkdir -p /home/${{ secrets.PI_USER }}/challenger-app/Database/migrations
            sudo chown -R ${{ secrets.PI_USER }}:${{ secrets.PI_USER }} /home/${{ secrets.PI_USER }}/challenger-app/Database
            sudo chmod -R 755 /home/${{ secrets.PI_USER }}/challenger-app/Database
            
            echo "âœ… Deployment directory prepared with proper permissions"

      - name: Copy project files to Raspberry Pi
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USER }}
          key: ${{ secrets.PI_SSH_KEY }}
          port: ${{ secrets.PI_SSH_PORT || 22 }}
          source: "api/**,chat/**,common/**,Database/**,go.mod,go.sum,docker-compose.prod.yml"
          target: "/home/${{ secrets.PI_USER }}/challenger-app"
          overwrite: true

      - name: Fix permissions after file copy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USER }}
          key: ${{ secrets.PI_SSH_KEY }}
          port: ${{ secrets.PI_SSH_PORT || 22 }}
          script: |
            # Ensure all files and directories have proper ownership
            chown -R ${{ secrets.PI_USER }}:${{ secrets.PI_USER }} /home/${{ secrets.PI_USER }}/challenger-app
            
            # Set proper permissions (755 for directories, 644 for files)
            find /home/${{ secrets.PI_USER }}/challenger-app -type d -exec chmod 755 {} \;
            find /home/${{ secrets.PI_USER }}/challenger-app -type f -exec chmod 644 {} \;
            
            # Ensure Database/migrations directory exists and has correct permissions
            mkdir -p /home/${{ secrets.PI_USER }}/challenger-app/Database/migrations
            chmod 755 /home/${{ secrets.PI_USER }}/challenger-app/Database/migrations
            
            echo "âœ… File permissions fixed"

      - name: Create .env file on Raspberry Pi
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USER }}
          key: ${{ secrets.PI_SSH_KEY }}
          port: ${{ secrets.PI_SSH_PORT || 22 }}
          script: |
            cd ~/challenger-app
            echo "DB_HOST=postgres" > .env
            echo "DB_PORT=5432" >> .env
            echo "DB_USER=${{ secrets.DB_USER }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            chmod 600 .env
            echo "âœ… .env file created"
            # Verify file exists and has content (without showing values)
            if [ -f .env ] && [ -s .env ]; then
              echo "âœ… .env file verified (contains $(wc -l < .env) lines)"
            else
              echo "âŒ .env file is missing or empty!"
              exit 1
            fi

      - name: Build and run Docker containers on Raspberry Pi
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USER }}
          key: ${{ secrets.PI_SSH_KEY }}
          port: ${{ secrets.PI_SSH_PORT || 22 }}
          script: |
            cd ~/challenger-app

            echo "ðŸš€ Building and updating containers (preserving data)..."
            # Verify .env file exists before starting containers
            if [ ! -f .env ]; then
              echo "âŒ .env file not found!"
              exit 1
            fi
            # Debug: Show that .env file exists and has content (without showing values)
            echo "ðŸ“‹ Verifying .env file..."
            if [ -f .env ]; then
              echo "âœ… .env file exists"
              echo "ðŸ“Š .env file has $(wc -l < .env) lines"
              # Show variable names only (not values)
              grep -o '^[^=]*' .env | while read var; do
                echo "  - $var is set"
              done
            fi
            docker compose -f docker-compose.prod.yml up -d --build

            echo "ðŸ”— Setting up Tailscale Funnel..."
            sudo tailscale funnel reset || true
            sudo tailscale funnel --bg --set-path /chat 8002
            sudo tailscale funnel --bg --set-path /api 8000

            echo "âœ… Deployment complete."
